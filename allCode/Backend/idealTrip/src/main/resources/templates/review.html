{{>header}}
<!--banner-slider-->
<br><br><br><br>
{{#logged}}
<div class="container">
    <div class="row">
        <div class="col-md-6 offset-md-3">
            <form method="post" action="/review/{{id}}">
                <div class="form-group">
                    <label for="titleReview">Título</label>
                    <input type="text" class="form-control" name="titleReview" required>
                </div>
                <div class="form-group">
                    <label for="contentReview">Contenido</label>
                    <textarea class="form-control" name="contentReview" required></textarea>
                </div>
                <div class="form-group">
                    <label for="ratingReview">Valoración</label>
                    <select class="form-control" name="ratingReview" required>
                        <option value="">-- Seleccionar valoración --</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Publicar</button>
                <input type="hidden" name="_csrf" value="{{token}}" />
            </form>
        </div>
    </div>
</div>
{{/logged}}

<script>
    let focusedElementBeforeModal;
    const modal = document.getElementById('modal');
    const modalOverlay = document.querySelector('.modal-overlay');

    window.onload = () => {
        const addReview = document.getElementById('review-add-btn');
        addReview.id = 'review-add-btn';
        addReview.innerHTML = '+';
        addReview.setAttribute('aria-label', 'add review');
        addReview.title = 'Add Review';
        addReview.addEventListener('click', openModal);
        addReview.click();
    }

    const openModal = () => {
        // Save current focus
        focusedElementBeforeModal = document.activeElement;

        // Listen for and trap the keyboard
        modal.addEventListener('keydown', trapTabKey);

        // Listen for indicators to close the modal
        modalOverlay.addEventListener('click', closeModal);
        // Close btn
        const closeBtn = document.querySelector('.close-btn');
        closeBtn.addEventListener('click', closeModal);

        // submit form
        const form = document.getElementById('review-form');
        form.addEventListener('submit', submitAddReview, false);

        // Find all focusable children
        var focusableElementsString = 'a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, object, embed, [tabindex="0"], [contenteditable]';
        var focusableElements = modal.querySelectorAll(focusableElementsString);
        // Convert NodeList to Array
        focusableElements = Array.prototype.slice.call(focusableElements);

        var firstTabStop = focusableElements[0];
        var lastTabStop = focusableElements[focusableElements.length - 1];

        // Show the modal and overlay
        modal.classList.add('show');
        modalOverlay.classList.add('show');

        // Focus first child
        const reviewName = document.getElementById('reviewName');
        reviewName.focus();

        function trapTabKey(e) {
            // Check for TAB key press
            if (e.keyCode === 9) {

                // SHIFT + TAB
                if (e.shiftKey) {
                    if (document.activeElement === firstTabStop) {
                        e.preventDefault();
                        lastTabStop.focus();
                    }

                    // TAB
                } else {
                    if (document.activeElement === lastTabStop) {
                        e.preventDefault();
                        firstTabStop.focus();
                    }
                }
            }

            // ESCAPE
            if (e.keyCode === 27) {
                closeModal();
            }
        }
    };

    const submitAddReview = (e) => {
        console.log('Form subbmitted!');
        e.preventDefault();
        closeModal();
    };

    const closeModal = () => {
        // Hide the modal and overlay
        modal.classList.remove('show');
        modalOverlay.classList.remove('show');

        const form = document.getElementById('review-form');
        form.reset();
        // Set focus back to element that had it before the modal was opened
        focusedElementBeforeModal.focus();
    };

    const setFocus = (evt) => {
        const rateRadios = document.getElementsByName('rate');
        const rateRadiosArr = Array.from(rateRadios);
        const anyChecked = rateRadiosArr.some(radio => { return radio.checked === true; });
        if (!anyChecked) {
            const star1 = document.getElementById('star1');
            star1.focus();
        }
    };

    const navRadioGroup = (evt) => {


        const star1 = document.getElementById('star1');
        const star2 = document.getElementById('star2');
        const star3 = document.getElementById('star3');
        const star4 = document.getElementById('star4');
        const star5 = document.getElementById('star5');

        if (['ArrowRight', 'ArrowLeft', 'ArrowDown', 'ArrowUp'].includes(evt.key)) {
            evt.preventDefault();
            if (evt.key === 'ArrowRight' || evt.key === 'ArrowDown') {
                switch (evt.target.id) {
                    case 'star1':
                        star2.focus();
                        star2.checked = true;
                        break;
                    case 'star2':
                        star3.focus();
                        star3.checked = true;
                        break;
                    case 'star3':
                        star4.focus();
                        star4.checked = true;
                        break;
                    case 'star4':
                        star5.focus();
                        star5.checked = true;
                        break;
                    case 'star5':
                        star1.focus();
                        star1.checked = true;
                        break;
                }
            } else if (evt.key === 'ArrowLeft' || evt.key === 'ArrowUp') {
                switch (evt.target.id) {
                    case 'star1':
                        star5.focus();
                        star5.checked = true;
                        break;
                    case 'star2':
                        star1.focus();
                        star1.checked = true;
                        break;
                    case 'star3':
                        star2.focus();
                        star2.checked = true;
                        break;
                    case 'star4':
                        star3.focus();
                        star3.checked = true;
                        break;
                    case 'star5':
                        star4.focus();
                        star4.checked = true;
                        break;
                }
            }
        }
    };
</script>

<!-- testimonials -->
<section class="w3l-clients" id="clients">
    <!-- /grids -->
    <div class="cusrtomer-layout py-5">
        <class class="container py-lg-4 py-md-3 pb-lg-0">
            <div class="heading text-center mx-auto">
                <h3 class="hny-title mb-md-5 mb-4">Lo que nuestros clientes dicen</h3>
            </div>
            <div class="review-list">
                {{#reviews}}
                <div class="review-box">
                    <div class="review-contentbox">
                        <h3 class="review-username">
                            {{#user.profileAvatarFile}}
                            <img src="/review/avatar/{{user.id}}" alt="Avatar" width="100" height="100">
                            {{/user.profileAvatarFile}}
                            {{^user.profileAvatarFile}}
                            <img src="../assets/images/null-avatar.png" alt="Null Avatar" width="100" height="100">
                            {{/user.profileAvatarFile}}
                            &nbsp;
                            {{user.name}}&nbsp;{{user.lastName}}
                        </h3>
                        <br>
                        <div class="review-rating" data-rating="{{ratingReview}}">
                            <span class="star">&#9733;</span>
                            <span class="star">&#9733;</span>
                            <span class="star">&#9733;</span>
                            <span class="star">&#9733;</span>
                            <span class="star">&#9733;</span>
                        </div>
                        <h4 class="review-title">{{titleReview}}</h4>
                        <p class="review-content">{{contentReview}}</p>
                        <!-- <div class="spinner"></div> -->
                    </div>
                </div>
                {{/reviews}}
            </div>

            <div id="load-more-container">
                {{#reviews.hasNext}}
                <button id="load-more-button" data-page="{{reviews.nextPageable.pageNumber}}">Mostrar más</button>
                {{/reviews.hasNext}}
            </div>



            <script>
                const loadMoreButton = document.querySelector('#load-more-button');
                const reviewContainer = document.querySelector('.review-list');

                loadMoreButton.addEventListener('click', function () {
                    const nextPage = this.getAttribute('data-page');

                    // We make the Ajax request to the server to get the reviews of the following page, without reloading the entire page
                    setTimeout(function () {
                        const xhr = new XMLHttpRequest();
                        xhr.open('GET', '?page=' + nextPage);
                        xhr.onload = function () {
                            if (xhr.status === 200) {
                                // We convert the server response to HTML and add it to the reviews container.
                                const parser = new DOMParser();
                                const html = parser.parseFromString(xhr.response, 'text/html');
                                reviewContainer.innerHTML += html.querySelector('.review-list').innerHTML;

                                //Update the page number of the "Show more" button and hide the button if there are no more pages.
                                const newPage = parseInt(nextPage) + 1;
                                loadMoreButton.setAttribute('data-page', newPage);
                                if (!html.querySelector('#load-more-button')) {
                                    loadMoreButton.style.display = 'none';
                                }

                                // Updating the star values in the added reviews.
                                const newReviewRatings = reviewContainer.querySelectorAll('.review-rating:not(.updated)');
                                newReviewRatings.forEach(newReviewRating => {
                                    const rating = parseInt(newReviewRating.getAttribute('data-rating'));
                                    const stars = newReviewRating.querySelectorAll('.star');

                                    // We add active stars based on the rating value.
                                    for (let i = 0; i < rating; i++) {
                                        stars[i].classList.add('active');
                                    }





                                    // We mark this review as updated so that it will not be updated again in the future.
                                    newReviewRating.classList.add('updated');
                                });
                                // We hide the spinner and show the button
                                spinner.style.display = 'none';
                                loadMoreButton.style.display = 'block';
                                if (!html.querySelector('#load-more-button')) {
                                    loadMoreButton.style.display = 'none'; //When there is no more "load more" in html, that is, there are no more pages of reviews available, we hide the button
                                }
                            } else {
                                console.error('Error en la carga de reviews');
                            }
                        };
                        xhr.send();

                    }, 0);
                });

            </script>

            <script>
                // Update star values for first 5 reviews
                const existingReviewRatings = reviewContainer.querySelectorAll('.review-rating');
                existingReviewRatings.forEach(existingReviewRating => {
                    const rating = parseInt(existingReviewRating.getAttribute('data-rating'));
                    const stars = existingReviewRating.querySelectorAll('.star');
                    for (let i = 0; i < rating; i++) {
                        stars[i].classList.add('active');
                    }
                    existingReviewRating.classList.add('updated');
                });
            </script>

    </div>
    <!-- /grids -->

    </class>
    </div>
    <!-- /grids -->
    </div>
    <!-- //grids -->
</section>
<!-- //testimonials -->

{{>footer}}

</html>